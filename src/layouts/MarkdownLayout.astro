---
import '../styles/global.css'
import { getCollection, getEntry } from 'astro:content'
import MainContent from '../components/MainContent.astro'
import TopBar from '../components/TopBar.astro'
import DesktopLeftSidebar from '../components/DesktopLeftSidebar.astro'
import FooterSection from '../components/ContextualColumn.astro'
import Footer from '../components/Footer.astro'

const { frontmatter } = Astro.props
const globalEntry = await getEntry('global', 'config')
if (!globalEntry) throw new Error('Missing global content entry: global/config')

const { site } = globalEntry.data
const news = (await getCollection('news'))
  .map((entry) => entry.data)
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
const currentPath = Astro.url.pathname
const isIndexPage = currentPath === '/'
const showToc = isIndexPage
const sidebarNewsCount = frontmatter?.sidebarNewsCount ?? (isIndexPage ? 0 : 3)
const sidebarNews = showToc ? [] : news.slice(0, sidebarNewsCount)
const showNewsSidebar = !showToc && sidebarNews.length > 0
---

<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{frontmatter?.title ? `${frontmatter.title} – ${site.title}` : site.title}</title>
    <meta name="description" content={frontmatter?.description || site.description} />
  </head>

  <body
    class="min-h-screen bg-gray-100 text-gray-800"
    x-data="{ sidebarOpen: false, tocOpen: false }"
    :class="{ 'overflow-hidden': sidebarOpen || tocOpen }"
    @keydown.window.escape="sidebarOpen = false; tocOpen = false"
  >
    <TopBar {showToc} />

    <!-- Fő konténer - max 1440px, középre igazítva -->
    <div class="relative mx-auto flex min-h-screen max-w-[1440px] flex-col bg-white lg:flex-row">
      <DesktopLeftSidebar />

      <MainContent {frontmatter}>
        <article class="prose prose-slate dark:prose-invert">
          <slot />
        </article>
      </MainContent>

      <FooterSection {showToc} {showNewsSidebar} {sidebarNews} />
    </div>

    <Footer />

    <script>
      import '../scripts/alpine.js'
    </script>
  </body>
</html>
