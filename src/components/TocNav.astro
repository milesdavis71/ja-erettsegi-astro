---
const { variant = 'desktop' } = Astro.props
const baseClasses = 'flex flex-col'
const isMobile = variant === 'mobile'
const containerClass = isMobile ? `${baseClasses} px-4 py-2 gap-4` : `${baseClasses} h-full px-6`
const listClass = isMobile
  ? 'list-none pl-0 space-y-2 text-base'
  : 'list-none pl-0 space-y-2 text-sm'
/**
 * A TocNav automatikusan kiemeli az éppen látható szakaszt
 * (pl. <section id="intro"> vagy <h2 id="section1"> alapján).
 *
 * Nem kell YAML-ból beolvasni, mert dinamikusan végigmegy a DOM elemein.
 */
---

<div
  x-data="{ 
    activeId: '',
    headings: [],
    init() {
      this.headings = Array.from(document.querySelectorAll('main h1[id], main h2[id], main h3[id], main h4[id], main h5[id], main h6[id]')).map(h => ({ 
        id: h.id, 
        label: h.textContent.trim() 
      }));
      
      const onScroll = () => {
        let currentId = '';
      // Top bar (h-16 = 64px) + némi padding
      const topThreshold = 80; 

        // Szűrjük azokat a címsorokat, amelyek már a küszöbérték fölött vannak
        const headingsAboveThreshold = this.headings.filter(h => {
            const element = document.getElementById(h.id);
            if (!element) return false;
            return element.getBoundingClientRect().top < topThreshold;
        });

        // Az aktív címsor az utolsó, amelyik áthaladt a küszöbön
        if (headingsAboveThreshold.length > 0) {
            currentId = headingsAboveThreshold[headingsAboveThreshold.length - 1].id;
        }

        this.activeId = currentId;
      };
      
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll(); // Kezdő állapot beállítása
    }
  }"
  class={containerClass}
>
  <h2 class={`text-lg font-semibold mb-4 ${isMobile ? 'px-1' : ''}`}>Tartalomjegyzék</h2>
  <nav>
    <ul class={listClass}>
      <template x-for="link in headings" :key="link.id">
        <li>
          <a
            :href="'#' + link.id"
            :class="activeId === link.id ? 'block pl-3 border-l-4 font-semibold transition no-underline' : 'block pl-3 border-l-4 border-transparent text-gray-700 hover:text-blue-600 hover:border-blue-200 transition no-underline'"
            :style="activeId === link.id ? { color: 'var(--link-base-color)', borderColor: 'var(--link-base-color)' } : {}"
            x-text="link.label"></a>
        </li>
      </template>
    </ul>
  </nav>
</div>
